<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>CPMWL 涂装商城</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f5f5f5}
.hidden{display:none}
header{background:#111;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
.menu-btn{font-size:24px;cursor:pointer}
nav{background:#222;color:#fff}
nav button{display:block;width:100%;padding:12px;border:none;background:#222;color:#fff;text-align:left}
nav button:hover{background:#444}
.page{padding:15px}
.card{background:#fff;padding:12px;margin:10px 0;border-radius:6px}
input,select,button{padding:8px;margin:5px 0;width:100%}
button{cursor:pointer}
</style>
</head>
<body>

<header>
  <div>CPMWL 涂装商城</div>
  <div class="menu-btn" onclick="toggleMenu()">☰</div>
</header>

<nav id="menu" class="hidden">
  <button onclick="showPage('home')">主页</button>
  <button onclick="showPage('shop')">商架</button>
  <button onclick="showPage('couponShop')">优惠码商城</button>
  <button onclick="showPage('points')">会员积分</button>
  <button id="loginBtn" onclick="showPage('login')">登入</button>
  <button id="logoutBtn" class="hidden" onclick="logout()">登出</button>
  <button id="cartBtn" onclick="showPage('cart')">购物车</button>
  <button id="adminBtn" class="hidden" onclick="openAdmin()">后台管理</button>
</nav>

<div id="home" class="page">
  <h2>欢迎来到 CPMWL 涂装商城</h2>
  <button onclick="showPage('shop')">立即购买</button>
</div>

<div id="shop" class="page hidden"></div>

<div id="couponShop" class="page hidden"></div>

<div id="points" class="page hidden">
  <h3>会员积分</h3>
  <p id="pointsText"></p>
</div>

<div id="login" class="page hidden">
  <div id="loginBox">
    <h3>登入</h3>
    <input id="loginUser" placeholder="用户名">
    <input id="loginPass" type="password" placeholder="密码">
    <button id="doLogin" disabled>登入</button>
    <p style="text-align:center">
      还没有账号？<button onclick="switchToRegister()">注册</button>
    </p>
  </div>
  <div id="registerBox" class="hidden">
    <h3>注册</h3>
    <input id="regUser" placeholder="用户名">
    <input id="regPass" type="password" placeholder="密码">
    <input id="regPass2" type="password" placeholder="确认密码">
    <input id="regPhone" placeholder="+60123456789">
    <button id="doRegister" disabled>注册</button>
    <p style="text-align:center">
      已有账号？<button onclick="switchToLogin()">返回登入</button>
    </p>
  </div>
  <p style="margin-top:15px;text-align:center">WHATSAPP：0102278829</p>
</div>

<div id="cart" class="page hidden"></div>
<div id="checkout" class="page hidden"></div>
<div id="tng" class="page hidden"></div>
<div id="admin" class="page hidden"></div>

<script>
/* ================== 数据区 ================== */
let users=[], products=[], orders=[], coupons=[];
try{
  users=JSON.parse(localStorage.getItem('users'))||[];
  products=JSON.parse(localStorage.getItem('products'))||[];
  orders=JSON.parse(localStorage.getItem('orders'))||[];
  coupons=JSON.parse(localStorage.getItem('coupons'))||[];
}catch(e){users=[];products=[];orders=[];coupons=[];}
if(!Array.isArray(users)) users=[]; if(!Array.isArray(products)) products=[];
if(!Array.isArray(orders)) orders=[]; if(!Array.isArray(coupons)) coupons=[];
let currentUser=JSON.parse(localStorage.getItem('currentUser'));
let cart=[], pointDiscount=0;

/* 固定后台账号 */
if(!users.find(u=>u.username==='CPMWLADMIN')){
  users.push({username:'CPMWLADMIN', password:'WLCY1111', phone:'', points:0});
  localStorage.setItem('users', JSON.stringify(users));
}

/* ================== 保存数据 ================== */
function saveAll(){
  localStorage.setItem('users',JSON.stringify(users));
  localStorage.setItem('products',JSON.stringify(products));
  localStorage.setItem('orders',JSON.stringify(orders));
  localStorage.setItem('coupons',JSON.stringify(coupons));
  localStorage.setItem('currentUser',JSON.stringify(currentUser));
}

/* ================== UI & 菜单 ================== */
function toggleMenu(){menu.classList.toggle('hidden');}
function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
function refreshAuthUI(){
  if(currentUser){
    loginBtn.classList.add('hidden'); logoutBtn.classList.remove('hidden');
    if(currentUser.username==='CPMWLADMIN') adminBtn.classList.remove('hidden'); else adminBtn.classList.add('hidden');
  }else{loginBtn.classList.remove('hidden'); logoutBtn.classList.add('hidden'); adminBtn.classList.add('hidden');}
}
function logout(){currentUser=null;saveAll();refreshAuthUI();showPage('home');}
function switchToRegister(){loginBox.classList.add('hidden');registerBox.classList.remove('hidden');}
function switchToLogin(){registerBox.classList.add('hidden');loginBox.classList.remove('hidden');}

/* ================== 登入/注册 ================== */
doLogin.onclick=()=>{
  let u=loginUser.value.trim(),p=loginPass.value;
  let user=users.find(x=>x.username===u && x.password===p);
  if(!user){alert('账号或密码错误');return;}
  currentUser=user; saveAll(); refreshAuthUI(); showPage('home'); updatePointsUI();
};
['loginUser','loginPass'].forEach(id=>document.getElementById(id).oninput=()=>{doLogin.disabled=!(loginUser.value && loginPass.value);});

doRegister.onclick=()=>{
  if(regPass.value!==regPass2.value){alert('密码不一致');return;}
  if(!/^\+601\d{8,9}$/.test(regPhone.value)){alert('电话号码格式错误');return;}
  if(users.find(u=>u.username===regUser.value)){alert('用户名已存在');return;}
  currentUser={username:regUser.value,password:regPass.value,phone:regPhone.value,points:99};
  users.push(currentUser); saveAll(); refreshAuthUI(); switchToLogin(); showPage('home'); updatePointsUI();
};
['regUser','regPass','regPass2','regPhone'].forEach(id=>document.getElementById(id).oninput=()=>{doRegister.disabled=!(regUser.value && regPass.value && regPass2.value && regPhone.value);});

/* ================== 积分显示 ================== */
function updatePointsUI(){pointsText.innerText=currentUser?`当前积分：${currentUser.points}`:'请登入查看积分';}

/* ================== 商架 ================== */
function renderShop(){
  shop.innerHTML='<h3>商架</h3>';
  products.forEach(p=>{
    let d=document.createElement('div'); d.className='card';
    d.innerHTML=`<b>${p.name}</b><br>价格：RM${p.price}<br>
      <button onclick="addToCart(${p.id})">加入购物车</button>`;
    shop.appendChild(d);
  });
}

function addToCart(id){
  if(!currentUser){alert('请先登入');return;}
  let p=products.find(x=>x.id===id); if(!p) return;
  let qty=parseInt(prompt('请输入数量','1'));
  if(!qty||qty<=0){alert('数量无效');return;}
  let cartItem=cart.find(c=>c.product.id===id);
  if(cartItem) cartItem.qty+=qty; else cart.push({product:p, qty});
  alert(`已加入购物车：${p.name} x${qty}`);
  renderCart();
  showPage('cart');
}

/* ================== 优惠码商城 ================== */
function renderCouponShop(){
  couponShop.innerHTML=`<h3>优惠码商城</h3>
  <div class="card"><b>10% 优惠券</b> RM9 <button onclick="buyCoupon('10%')">立即购买</button></div>
  <div class="card"><b>20% 优惠券</b> RM19 <button onclick="buyCoupon('20%')">立即购买</button></div>
  <div class="card"><b>自定义 RM 优惠券</b><br>
    <input id="customRM" type="number" min="1" placeholder="RM">
    <button onclick="buyCustom()">立即购买</button>
  </div>`;
}

function buyCoupon(type){
  if(!currentUser){alert('请先登入'); return;}
  let code='CPMWL'+Date.now();
  let price = type==='10%'?9:19;
  let product={name:type+' 优惠券', price:price, code:code};
  cart=[{product, qty:1}];
  coupons.push({code,type});
  saveAll();
  checkoutCoupon();
}

function buyCustom(){
  let v=parseInt(document.getElementById('customRM').value);
  if(!v||v<=0||v%1!==0){alert('请输入整数金额');return;}
  let code='CPMWL'+Date.now();
  let product={name:'自定义 RM'+v+' 优惠券', price:v, code:code};
  cart=[{product, qty:1}];
  coupons.push({code,type:'RM'+v});
  saveAll();
  checkoutCoupon();
}

/* ================== 购物车 ================== */
function renderCart(){
  let cartDiv=document.getElementById('cart');
  let html='<h3>购物车</h3>'; 
  let total=0;
  cart.forEach(c=>{
    let s=c.product.price*c.qty; total+=s;
    html+=`${c.product.name} x${c.qty} = RM${s} <br>优惠码: ${c.product.code || ''}<br>`;
  });
  html+=`<p>总额：RM${total}</p><button onclick="checkoutCoupon()">付款</button>`;
  cartDiv.innerHTML=html;
}

/* ================== 确认付款 ================== */
function checkoutCoupon(){
  pointDiscount=0;
  let orderId='#CPMWL'+Math.floor(Math.random()*1000000);
  let base=cart.reduce((s,c)=>s.product.price*c.qty,0);
  let itemsHTML='';
  cart.forEach(c=>{itemsHTML+=`${c.product.name} x${c.qty} - RM${c.product.price}<br>优惠码: ${c.product.code || ''}<br>`;});
  
  checkout.innerHTML=`<h3>确认付款</h3>
    <p>订单号：${orderId}</p>
    ${itemsHTML}
    <p>商品总额：RM${base}</p>
    <p id="pd">积分抵扣：RM0</p>
    <button id="usePoints" ${currentUser.points<100?'disabled':''}>使用100积分抵RM1</button>
    <h4>付款方式</h4>
    <label><input type="radio" checked>TNG Ewallet</label>
    <button onclick="goTNG('${orderId}',${base})">付款</button>`;
  showPage('checkout');
  
  document.getElementById('usePoints').onclick = ()=>{
    currentUser.points -= 100; 
    pointDiscount++; 
    document.getElementById('pd').innerText = '积分抵扣：RM'+pointDiscount;
    if(currentUser.points<100) document.getElementById('usePoints').disabled=true;
    updatePointsUI();
  };
}

/* ================== TNG付款 ================== */
function goTNG(id,base){
  let final=base-pointDiscount;
  orders.push({id,items:cart,total:final,paid:false,shipped:false});
  currentUser.points+=Math.floor(final);
  saveAll();
  tng.innerHTML=`<h3>TNG 付款</h3>
    <img src="https://i.postimg.cc/ZYVmWqHP/received_814562978153891.jpg" width="200"><br>
    <p>备注：${id}</p>
    <p>金额：RM${final}</p>
    <button onclick="finish()">完成订单</button>`;
  showPage('tng');
}

function finish(){cart=[]; saveAll(); showPage('home'); updatePointsUI();}

/* ================== 后台 ================== */
function openAdmin(){if(!currentUser||currentUser.username!=='CPMWLADMIN'){alert('无权限');return;} renderAdmin(); showPage('admin');}

function renderAdmin(){
  admin.innerHTML='<h3>后台管理</h3>';
  /* 商品管理 */
  admin.innerHTML+=`<h4>商品管理</h4>
    <input id="pname" placeholder="名称">
    <input id="pprice" type="number" placeholder="价格">
    <button onclick="addProduct()">添加</button>`;
  products.forEach(p=>{admin.innerHTML+=`${p.name} RM${p.price} <button onclick="delProduct(${p.id})">删除</button><br>`;});
  
  /* 订单管理 */
  admin.innerHTML+='<h4>订单管理</h4>';
  orders.forEach(o=>{
    admin.innerHTML += `${o.id} 总额RM${o.total} 付款:${o.paid?'是':'否'} 发货:${o.shipped?'是':'否'} 
      <button onclick="markPaid('${o.id}')">付款✓</button> 
      <button onclick="markShipped('${o.id}')">发货✓</button><br>`;
  });
  
  /* 优惠码管理 */
  admin.innerHTML+=`<h4>优惠码管理</h4>
    <input id="newCode" placeholder="代码">
    <input id="newType" placeholder="%或RM">
    <button onclick="addCouponAdmin()">添加优惠码</button><br>`;
  coupons.forEach((c,i)=>{admin.innerHTML+=`${c.code} (${c.type}) <button onclick="coupons.splice(${i},1);saveAll();renderAdmin()">删除</button><br>`;});
}

function addProduct(){
  let name=document.getElementById('pname').value; 
  let price=Number(document.getElementById('pprice').value);
  if(!name||!price){alert('请填写名称和价格');return;}
  let id=products.length?products[products.length-1].id+1:1;
  products.push({id,name,price,img:''});
  saveAll(); renderShop(); renderAdmin();
}
function delProduct(id){products=products.filter(p=>p.id!==id); saveAll(); renderShop(); renderAdmin();}

function addCouponAdmin(){
  let code=document.getElementById('newCode').value.trim(); 
  let type=document.getElementById('newType').value.trim(); 
  if(!code||!type){alert('请输入代码和类型');return;}
  coupons.push({code,type}); saveAll(); renderAdmin();
}

function markPaid(id){let o=orders.find(x=>x.id===id); if(!o) return; o.paid=true; saveAll(); renderAdmin();}
function markShipped(id){let o=orders.find(x=>x.id===id); if(!o) return; o.shipped=true; saveAll(); renderAdmin();}

/* ================== 初始化 ================== */
showPage('home'); renderShop(); renderCouponShop(); refreshAuthUI(); updatePointsUI();
</script>
</body>
</html>

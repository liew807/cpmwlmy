<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>CPMWL 涂装商城</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;font-family:Arial;background:#f5f5f5}
.hidden{display:none}
header{background:#111;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
.menu-btn{font-size:24px;cursor:pointer}
nav{background:#222;color:#fff}
nav button{display:block;width:100%;padding:12px;border:none;background:#222;color:#fff;text-align:left}
nav button:hover{background:#444}
.page{padding:15px}
.card{background:#fff;padding:12px;margin:10px 0;border-radius:6px}
input,select,button{padding:8px;margin:5px 0;width:100%}
button{cursor:pointer}
.tng-payment{text-align:center;margin:20px 0}
.tng-payment img{max-width:100%;border:2px solid #333;border-radius:8px;margin:10px 0}
.order-summary{background:#fff;padding:15px;border-radius:8px;margin:15px 0}
.order-item{border-bottom:1px solid #eee;padding:10px 0}
.order-item:last-child{border-bottom:none}
.payment-instructions{background:#fff3cd;border-left:4px solid #ffc107;padding:10px;margin:10px 0}
</style>
</head>
<body>

<header>
  <div>CPMWL 涂装商城</div>
  <div class="menu-btn" onclick="toggleMenu()">☰</div>
</header>

<nav id="menu" class="hidden">
  <button onclick="showPage('home')">主页</button>
  <button onclick="showPage('shop')">商架</button>
  <button onclick="showPage('couponShop')">优惠码商城</button>
  <button onclick="showPage('points')">会员积分</button>
  <button id="loginBtn" onclick="showPage('login')">登入</button>
  <button id="logoutBtn" class="hidden" onclick="logout()">登出</button>
  <button id="cartBtn" onclick="showPage('cart')">购物车</button>
  <button id="adminBtn" class="hidden" onclick="openAdmin()">后台管理</button>
</nav>

<div id="home" class="page">
  <h2>欢迎来到 CPMWL 涂装商城</h2>
  <div class="card">
    <p>专业汽车涂装服务，质量保证，价格优惠</p>
    <button onclick="showPage('shop')">立即购买</button>
    <button onclick="showPage('couponShop')">购买优惠券</button>
  </div>
</div>

<div id="shop" class="page hidden"></div>
<div id="couponShop" class="page hidden"></div>
<div id="points" class="page hidden">
  <h3>会员积分</h3>
  <p id="pointsText"></p>
</div>

<div id="login" class="page hidden">
  <div id="loginBox">
    <h3>登入</h3>
    <input id="loginUser" placeholder="用户名">
    <input id="loginPass" type="password" placeholder="密码">
    <button id="doLogin" disabled>登入</button>
    <p style="text-align:center">
      还没有账号？<button onclick="switchToRegister()">注册</button>
    </p>
  </div>
  <div id="registerBox" class="hidden">
    <h3>注册</h3>
    <input id="regUser" placeholder="用户名">
    <input id="regPass" type="password" placeholder="密码">
    <input id="regPass2" type="password" placeholder="确认密码">
    <input id="regPhone" placeholder="+60123456789">
    <button id="doRegister" disabled>注册</button>
    <p style="text-align:center">
      已有账号？<button onclick="switchToLogin()">返回登入</button>
    </p>
  </div>
  <p style="margin-top:15px;text-align:center">客服 WHATSAPP：010-2278829</p>
</div>

<div id="cart" class="page hidden"></div>
<div id="checkout" class="page hidden"></div>
<div id="tng" class="page hidden"></div>
<div id="admin" class="page hidden"></div>

<script>
/* ================== 数据区 ================== */
let users=[], products=[], orders=[], coupons=[];
try{
  users=JSON.parse(localStorage.getItem('users'))||[];
  products=JSON.parse(localStorage.getItem('products'))||[];
  orders=JSON.parse(localStorage.getItem('orders'))||[];
  coupons=JSON.parse(localStorage.getItem('coupons'))||[];
}catch(e){users=[];products=[];orders=[];coupons=[];}
if(!Array.isArray(users)) users=[]; if(!Array.isArray(products)) products=[];
if(!Array.isArray(orders)) orders=[]; if(!Array.isArray(coupons)) coupons=[];
let currentUser=JSON.parse(localStorage.getItem('currentUser'));
let cart=[], pointDiscount=0;

/* 固定后台账号 */
if(!users.find(u=>u.username==='CPMWLADMIN')){
  users.push({username:'CPMWLADMIN', password:'WLCY1111', phone:'', points:0});
  localStorage.setItem('users', JSON.stringify(users));
}

/* 初始化商品数据（如果为空） */
if(products.length===0){
  products=[
    {id:1,name:'汽车全车喷漆',price:299.99,description:'专业汽车全车喷漆服务'},
    {id:2,name:'摩托车涂装',price:149.99,description:'摩托车定制涂装'},
    {id:3,name:'轮毂改色',price:79.99,description:'汽车轮毂专业改色'},
    {id:4,name:'车身贴膜',price:199.99,description:'车身保护膜/改色膜'},
    {id:5,name:'局部修复',price:59.99,description:'车身局部划痕修复'}
  ];
  localStorage.setItem('products', JSON.stringify(products));
}

/* ================== 保存数据 ================== */
function saveAll(){
  localStorage.setItem('users',JSON.stringify(users));
  localStorage.setItem('products',JSON.stringify(products));
  localStorage.setItem('orders',JSON.stringify(orders));
  localStorage.setItem('coupons',JSON.stringify(coupons));
  localStorage.setItem('currentUser',JSON.stringify(currentUser));
}

/* ================== UI & 菜单 ================== */
function toggleMenu(){menu.classList.toggle('hidden');}
function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
function refreshAuthUI(){
  if(currentUser){
    loginBtn.classList.add('hidden'); logoutBtn.classList.remove('hidden');
    if(currentUser.username==='CPMWLADMIN') adminBtn.classList.remove('hidden'); else adminBtn.classList.add('hidden');
  }else{loginBtn.classList.remove('hidden'); logoutBtn.classList.add('hidden'); adminBtn.classList.add('hidden');}
}
function logout(){currentUser=null;saveAll();refreshAuthUI();showPage('home');}
function switchToRegister(){loginBox.classList.add('hidden');registerBox.classList.remove('hidden');}
function switchToLogin(){registerBox.classList.add('hidden');loginBox.classList.remove('hidden');}

/* ================== 登入/注册 ================== */
doLogin.onclick=()=>{
  let u=loginUser.value.trim(),p=loginPass.value;
  let user=users.find(x=>x.username===u && x.password===p);
  if(!user){alert('账号或密码错误');return;}
  currentUser=user; saveAll(); refreshAuthUI(); showPage('home'); updatePointsUI();
};
['loginUser','loginPass'].forEach(id=>document.getElementById(id).oninput=()=>{doLogin.disabled=!(loginUser.value && loginPass.value);});

doRegister.onclick=()=>{
  if(regPass.value!==regPass2.value){alert('密码不一致');return;}
  if(!/^\+601\d{8,9}$/.test(regPhone.value)){alert('电话号码格式错误');return;}
  if(users.find(u=>u.username===regUser.value)){alert('用户名已存在');return;}
  currentUser={username:regUser.value,password:regPass.value,phone:regPhone.value,points:99};
  users.push(currentUser); saveAll(); refreshAuthUI(); switchToLogin(); showPage('home'); updatePointsUI();
};
['regUser','regPass','regPass2','regPhone'].forEach(id=>document.getElementById(id).oninput=()=>{doRegister.disabled=!(regUser.value && regPass.value && regPass2.value && regPhone.value);});

/* ================== 积分显示 ================== */
function updatePointsUI(){pointsText.innerText=currentUser?`当前积分：${currentUser.points}`:'请登入查看积分';}

/* ================== 商架 ================== */
function renderShop(){
  shop.innerHTML='<h3>商架</h3>';
  products.forEach(p=>{
    let d=document.createElement('div'); d.className='card';
    d.innerHTML=`<b>${p.name}</b><br>价格：RM${p.price}<br>${p.description||''}
      <button onclick="addToCart(${p.id})">加入购物车</button>`;
    shop.appendChild(d);
  });
}

function addToCart(id){
  if(!currentUser){alert('请先登入');return;}
  let p=products.find(x=>x.id===id); if(!p) return;
  let qty=parseInt(prompt('请输入数量','1'));
  if(!qty||qty<=0){alert('数量无效');return;}
  let cartItem=cart.find(c=>c.product.id===id);
  if(cartItem) cartItem.qty+=qty; else cart.push({product:p, qty});
  alert(`已加入购物车：${p.name} x${qty}`);
  renderCart();
  showPage('cart');
}

/* ================== 优惠码商城 ================== */
function renderCouponShop(){
  couponShop.innerHTML=`<h3>优惠码商城</h3>
  <div class="card"><b>10% 优惠券</b> RM9 <button onclick="buyCoupon('10%')">立即购买</button></div>
  <div class="card"><b>20% 优惠券</b> RM19 <button onclick="buyCoupon('20%')">立即购买</button></div>
  <div class="card"><b>自定义 RM 优惠券</b><br>
    <input id="customRM" type="number" min="1" placeholder="RM">
    <button onclick="buyCustom()">立即购买</button>
  </div>`;
}

function buyCoupon(type){
  if(!currentUser){alert('请先登入'); return;}
  let price = type==='10%'?9:19;
  if(currentUser.points < price){alert(`需要${price}积分，当前只有${currentUser.points}积分`);return;}
  
  let code='CPMWL'+Date.now()+Math.floor(Math.random()*1000);
  let product={name:type+' 优惠券', price:price, code:code};
  cart=[{product, qty:1}];
  coupons.push({code,type});
  
  currentUser.points -= price;
  saveAll();
  updatePointsUI();
  alert(`购买成功！优惠码：${code}，已扣除${price}积分`);
  checkoutCoupon();
}

function buyCustom(){
  if(!currentUser){alert('请先登入'); return;}
  let v=parseInt(document.getElementById('customRM').value);
  if(!v||v<=0||v%1!==0){alert('请输入整数金额');return;}
  if(currentUser.points < v){alert(`需要${v}积分，当前只有${currentUser.points}积分`);return;}
  
  let code='CPMWL'+Date.now()+Math.floor(Math.random()*1000);
  let product={name:'自定义 RM'+v+' 优惠券', price:v, code:code};
  cart=[{product, qty:1}];
  coupons.push({code,type:'RM'+v});
  
  currentUser.points -= v;
  saveAll();
  updatePointsUI();
  alert(`购买成功！优惠码：${code}，已扣除${v}积分`);
  checkoutCoupon();
}

/* ================== 购物车 ================== */
function renderCart(){
  let cartDiv=document.getElementById('cart');
  cartDiv.innerHTML='<h3>购物车</h3>';
  
  if(cart.length===0){
    cartDiv.innerHTML+='<div class="card">购物车为空</div>';
    return;
  }
  
  let total=0;
  cart.forEach((c,index)=>{
    let s=c.product.price*c.qty; total+=s;
    let d=document.createElement('div'); d.className='card';
    d.innerHTML=`
      <b>${c.product.name}</b><br>
      单价：RM${c.product.price}<br>
      数量：${c.qty}<br>
      小计：RM${s}<br>
      ${c.product.code?'优惠码：'+c.product.code:''}
      <button onclick="removeFromCart(${index})">移除</button>
    `;
    cartDiv.appendChild(d);
  });
  
  cartDiv.innerHTML+=`<div class="card"><b>商品总额：RM${total}</b><br><button onclick="goToCheckout()">去结账</button></div>`;
}

function removeFromCart(index){
  cart.splice(index,1);
  renderCart();
}

function goToCheckout(){
  if(cart.length===0){alert('购物车为空');return;}
  checkoutCoupon();
}

/* ================== 付款页面 ================== */
function checkoutCoupon(){
  pointDiscount=0;
  let orderId='#CPMWL'+Math.floor(Math.random()*1000000);
  let base=0;
  let itemsHTML='<div class="order-summary"><h4>订单详情</h4>';
  
  cart.forEach(c=>{
    let itemTotal=c.product.price*c.qty;
    base+=itemTotal;
    itemsHTML+=`
      <div class="order-item">
        <b>${c.product.name}</b><br>
        单价：RM${c.product.price} × ${c.qty} = RM${itemTotal}<br>
        ${c.product.code?'优惠码：'+c.product.code:''}
      </div>
    `;
  });
  itemsHTML+='</div>';
  
  checkout.innerHTML=`<h3>确认付款</h3>
    <div class="card">
      <p><b>订单号：</b>${orderId}</p>
      ${itemsHTML}
      <p><b>商品总额：</b>RM${base}</p>
      <p id="pd"><b>积分抵扣：</b>RM${pointDiscount}</p>
      ${currentUser.points>=100?`<button onclick="usePoints()">使用100积分抵扣RM1</button>`:''}
    </div>
    <div class="card">
      <h4>总计应付：<span id="finalAmount">RM${base-pointDiscount}</span></h4>
    </div>
    <div class="card">
      <h4>选择付款方式</h4>
      <label style="display:block;padding:10px;">
        <input type="radio" name="payment" value="tng" checked> TNG eWallet
      </label>
      <button onclick="goTNG('${orderId}',${base})" style="background:#28a745;color:white;font-size:16px;padding:12px;">确认付款</button>
    </div>`;
  showPage('checkout');
}

function usePoints(){
  if(currentUser.points<100){alert('积分不足');return;}
  currentUser.points -= 100;
  pointDiscount++;
  document.getElementById('pd').innerText = '积分抵扣：RM'+pointDiscount;
  document.getElementById('finalAmount').innerText = 'RM' + (cart.reduce((s,c)=>s+c.product.price*c.qty,0)-pointDiscount);
  updatePointsUI();
  saveAll();
}

/* ================== TNG付款页面（使用你的二维码）================== */
function goTNG(id,base){
  let final=base-pointDiscount;
  orders.push({
    id,
    items:[...cart],
    total:final,
    paid:false,
    shipped:false,
    time:new Date().toLocaleString()
  });
  currentUser.points+=Math.floor(final);
  saveAll();
  
  tng.innerHTML=`
    <h3>TNG 付款</h3>
    <div class="tng-payment">
      <div style="font-size:18px;color:#333;margin:10px 0;padding:10px;background:#fff;border-radius:8px;">
        <p><b>订单号：</b> ${id}</p>
        <p><b>付款金额：</b> RM${final}</p>
        <p><b>备注信息：</b> ${id}</p>
      </div>
      
      <div style="margin:20px 0;">
        <h4>请扫描下方二维码付款</h4>
        <img src="https://i.postimg.cc/ZYVmWqHP/received-814562978153891.jpg" alt="TNG付款二维码" width="250">
      </div>
      
      <div class="payment-instructions">
        <h4>付款步骤：</h4>
        <p>1. 打开你的Touch 'n Go eWallet应用</p>
        <p>2. 点击"Scan"扫描上方二维码</p>
        <p>3. 确认付款金额：<b>RM${final}</b></p>
        <p>4. 在备注/Description填写：<b>${id}</b></p>
        <p>5. 完成付款后点击下方按钮</p>
      </div>
      
      <div style="margin:20px;">
        <button onclick="finishPayment('${id}')" style="background:#28a745;color:white;padding:12px 30px;font-size:16px;margin:5px;">
          ✅ 我已付款完成
        </button>
        <button onclick="showPage('checkout')" style="background:#6c757d;color:white;padding:12px 30px;font-size:16px;margin:5px;">
          ↩️ 返回修改订单
        </button>
      </div>
      
      <div class="card" style="background:#f8f9fa;">
        <p><b>重要提示：</b></p>
        <p>• 付款后请截图保存收据</p>
        <p>• 系统将自动发放积分奖励</p>
        <p>• 如有问题请联系WhatsApp: 010-2278829</p>
      </div>
    </div>`;
  showPage('tng');
}

function finishPayment(orderId){
  let order=orders.find(o=>o.id===orderId);
  if(order){
    order.paid=true;
    order.paidTime=new Date().toLocaleString();
    order.status='已付款';
  }
  saveAll();
  
  let earnedPoints=Math.floor(cart.reduce((s,c)=>s+c.product.price*c.qty,0)-pointDiscount);
  alert(`✅ 付款成功！\n\n订单号：${orderId}\n付款金额：RM${order.total}\n获得积分：${earnedPoints}\n\n订单状态已更新，感谢您的购买！`);
  
  cart=[];
  pointDiscount=0;
  showPage('home');
  updatePointsUI();
}

/* ================== 后台管理 ================== */
function openAdmin(){
  if(!currentUser||currentUser.username!=='CPMWLADMIN'){alert('无权限');return;}
  renderAdmin();
  showPage('admin');
}

function renderAdmin(){
  admin.innerHTML='<h3>后台管理系统</h3>';
  
  // 商品管理
  admin.innerHTML+=`<div class="card"><h4>添加商品</h4>
    <input id="pname" placeholder="商品名称">
    <input id="pprice" type="number" placeholder="价格">
    <input id="pdesc" placeholder="描述">
    <button onclick="addProduct()">添加商品</button></div>`;
  
  admin.innerHTML+='<h4>商品列表</h4>';
  if(products.length===0){
    admin.innerHTML+='<div class="card">暂无商品</div>';
  }else{
    products.forEach(p=>{
      admin.innerHTML+=`<div class="card">${p.name} - RM${p.price}<br>
        <button onclick="delProduct(${p.id})">删除</button></div>`;
    });
  }
  
  // 订单管理
  admin.innerHTML+='<h4>订单管理</h4>';
  if(orders.length===0){
    admin.innerHTML+='<div class="card">暂无订单</div>';
  }else{
    orders.forEach(o=>{
      admin.innerHTML+=`<div class="card">
        <b>订单号：</b>${o.id}<br>
        <b>金额：</b>RM${o.total}<br>
        <b>状态：</b>${o.paid?'已付款':'未付款'}<br>
        <b>时间：</b>${o.time}<br>
        <button onclick="markPaid('${o.id}')">标记为已付款</button>
        <button onclick="markShipped('${o.id}')">标记为已发货</button>
      </div>`;
    });
  }
  
  // 优惠码管理
  admin.innerHTML+=`<h4>优惠码管理</h4>
    <div class="card">
      <input id="newCode" placeholder="优惠码">
      <input id="newType" placeholder="类型(10%,20%,RM)">
      <button onclick="addCouponAdmin()">添加优惠码</button>
    </div>`;
  
  if(coupons.length===0){
    admin.innerHTML+='<div class="card">暂无优惠码</div>';
  }else{
    coupons.forEach((c,i)=>{
      admin.innerHTML+=`<div class="card">${c.code} (${c.type}) 
        <button onclick="delCoupon(${i})">删除</button></div>`;
    });
  }
  
  // 数据管理
  admin.innerHTML+=`<h4>数据管理</h4>
    <div class="card">
      <button onclick="exportData()">导出数据</button>
      <button onclick="clearData()" style="background:#dc3545;color:white;">清空所有数据</button>
    </div>`;
}

function addProduct(){
  let name=document.getElementById('pname').value.trim();
  let price=Number(document.getElementById('pprice').value);
  let desc=document.getElementById('pdesc').value.trim();
  
  if(!name||!price){alert('请填写商品名称和价格');return;}
  let id=products.length>0?products[products.length-1].id+1:1;
  products.push({id,name,price,description:desc});
  saveAll();
  renderShop();
  renderAdmin();
  alert('商品添加成功！');
}

function delProduct(id){
  if(!confirm('确定要删除这个商品吗？')) return;
  products=products.filter(p=>p.id!==id);
  saveAll();
  renderShop();
  renderAdmin();
}

function addCouponAdmin(){
  let code=document.getElementById('newCode').value.trim();
  let type=document.getElementById('newType').value.trim();
  if(!code||!type){alert('请输入优惠码和类型');return;}
  coupons.push({code,type});
  saveAll();
  renderAdmin();
  alert('优惠码添加成功！');
}

function delCoupon(index){
  if(!confirm('确定要删除这个优惠码吗？')) return;
  coupons.splice(index,1);
  saveAll();
  renderAdmin();
}

function markPaid(id){
  let order=orders.find(o=>o.id===id);
  if(order){
    order.paid=true;
    order.status='已付款';
    saveAll();
    renderAdmin();
    alert('订单已标记为已付款');
  }
}

function markShipped(id){
  let order=orders.find(o=>o.id===id);
  if(order){
    order.shipped=true;
    order.status='已发货';
    saveAll();
    renderAdmin();
    alert('订单已标记为已发货');
  }
}

function exportData(){
  let data={
    users:users,
    products:products,
    orders:orders,
    coupons:coupons,
    exportedAt:new Date().toLocaleString()
  };
  let dataStr=JSON.stringify(data,null,2);
  let dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(dataStr);
  let exportFileDefaultName='cpmwl_data.json';
  let linkElement=document.createElement('a');
  linkElement.setAttribute('href',dataUri);
  linkElement.setAttribute('download',exportFileDefaultName);
  linkElement.click();
  alert('数据已导出为JSON文件');
}

function clearData(){
  if(!confirm('⚠️ 警告！这将清除所有数据！确定继续吗？')) return;
  localStorage.clear();
  users=[];
  products=[];
  orders=[];
  coupons=[];
  currentUser=null;
  cart=[];
  pointDiscount=0;
  location.reload();
}

/* ================== 初始化 ================== */
showPage('home');
renderShop();
renderCouponShop();
refreshAuthUI();
updatePointsUI();

// 添加示例商品按钮（仅当没有商品时显示）
if(products.length===0){
  setTimeout(()=>{
    if(confirm('检测到没有商品，是否添加示例商品？')){
      products=[
        {id:1,name:'汽车全车喷漆',price:299.99,description:'专业汽车全车喷漆服务'},
        {id:2,name:'摩托车涂装',price:149.99,description:'摩托车定制涂装'},
        {id:3,name:'轮毂改色',price:79.99,description:'汽车轮毂专业改色'},
        {id:4,name:'车身贴膜',price:199.99,description:'车身保护膜/改色膜'},
        {id:5,name:'局部修复',price:59.99,description:'车身局部划痕修复'}
      ];
      localStorage.setItem('products', JSON.stringify(products));
      renderShop();
      alert('示例商品已添加！');
    }
  }, 1000);
}
</script>
</body>
</html>
